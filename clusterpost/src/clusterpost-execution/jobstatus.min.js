var _=require("underscore");module.exports=function(t,e){var u=require("./executionserver.methods")(e),n=require("./"+e.engine)(e);const r=function(e){return u.getDocument(t._id).then(function(t){t.jobstatus.uploadstatus=e;for(var n=!0,r=0;r<e.length;r++)e[r].ok||(n=!1);return t.jobstatus.status=n?"DONE":"FAIL",t.timestampend=new Date,u.uploadDocumentDataProvider(t)})};return"UPLOADING"===t.jobstatus.status?u.checkAllDocumentOutputs(t).then(r):n.getJobStatus(t).then(function(e){return"DONE"===e.status||"EXIT"===e.status?(t.jobstatus.status="UPLOADING",u.uploadDocumentDataProvider(t).then(function(e){return t._rev=e.rev,t}).then(function(t){return u.setAllDocumentOutputs(t)}).then(r)):(t.jobstatus=_.extend(t.jobstatus,e),u.uploadDocumentDataProvider(t).then(function(){return e}))})};