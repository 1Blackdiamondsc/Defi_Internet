angular.module("clusterpost-list").directive("clusterpostApp",function(e,o,t,n,a,r){return{restrict:"E",link:function(n,a){n.jobs={selectedJob:{}},n.jobs.onFilter=function(e){n.jobs.filteredJobs=e},n.updateStatus=function(e){t.getJobStatus(e._id).then(function(o){e.jobstatus=o.data}).catch(function(e){throw console.error(e),e})},n.killJob=function(e){t.killJob(e._id).then(function(o){e.jobstatus=o.data}).catch(function(e){throw console.error(e),e})},n.removeRow=function(e){var o=n.rowCollection.indexOf(e);-1!==o&&n.rowCollection.splice(o,1)},n.deleteJob=function(e){t.deleteJob(e._id).then(function(o){for(var t=0;t<n.jobs.data.length;t++)n.jobs.data[t]._id===e._id&&n.jobs.data.splice(t,1)}).catch(function(e){throw console.error(e),e})},n.saveJob=function(e){return t.updateJob(angular.copy(e)).then(function(o){o&&o.data&&o.data[0]&&o.data[0].rev&&(e._rev=o.data[0].rev)}).catch(function(e){console.error(e)})},n.runJob=function(e,o){t.submitJob(e._id,o).then(function(e){n.getDB()}).catch(function(e){console.error(e)})},n.getDB=function(){t.getUserJobs({userEmail:n.appUser.selectedUser.email,executable:n.appName}).then(function(e){n.jobs.data=e.data,n.jobs.status=_.uniq(_.pluck(_.pluck(e.data,"jobstatus"),"status")),n.jobs.executables=_.uniq(_.pluck(e.data,"executable"))}).catch(function(e){console.error(e)})},n.showJobDetail=function(e){n.jobs.selectedJob.job=e,n.activeTab=1,t.getAttachment(e._id,"stdout.out","text").then(function(e){n.jobs.selectedJob.stdout=e.data.replace(/\n/g,"<br>")}).catch(console.error),t.getAttachment(e._id,"stderr.err","text").then(function(e){n.jobs.selectedJob.stderr=e.data.replace(/\n/g,"<br>")}).catch(console.error)},n.runAllJobs=function(){if(n.jobs.filteredJobs){var e=_.map(n.jobs.filteredJobs,function(e){return t.submitJob(e._id).then(function(e){console.log(e)}).catch(console.error)});Promise.all(e).catch(console.error)}},n.updateAllJobs=function(){if(n.jobs.filteredJobs){var e=_.map(n.jobs.filteredJobs,function(e){return t.getJobStatus(e._id).then(function(o){e.jobstatus=o.data}).catch(console.error)});Promise.all(e).catch(console.error)}},n.deleteAllJobs=function(){if(n.jobs.filteredJobs){var e=_.map(n.jobs.filteredJobs,n.deleteJob);Promise.all(e).catch(console.error)}},n.killAllJobs=function(){if(n.jobs.filteredJobs){var e=_.map(n.jobs.filteredJobs,n.killJob);Promise.all(e).catch(console.error)}},n.jobAppCallback=function(e){n.jobCallback&&n.jobCallback(e)},n.numJobsInPage=[{id:"0",value:"10"},{id:"1",value:"50"},{id:"2",value:"100"}],n.rowCollection=[],n.forceRunJob=!1,n.activeTab=0,n.appUser={},r.getUser().then(function(o){return n.appUser.selectedUser=o,n.appUser.user=o,n.appUser.user.scope.indexOf("admin")?r.getUsers().then(function(o){return n.appUser.allUsers=o.data,e.adminCpUid&&(n.appUser.selectedUser=_.find(n.appUser.allUsers,function(o){return o._id===e.adminCpUid})),n.getDB()}):n.getDB()}).catch(console.error),n.appUser.userChange=function(){n.getDB(),o.search("adminCpUid",n.appUser.selectedUser._id)},n.getJobName=function(e){return e.name?e.name:e._id},n.downloadAllJobs=function(){if(n.jobs.filteredJobs){var e=_.map(n.jobs.filteredJobs,n.downloadJob);Promise.all(e).catch(console.error)}},n.downloadJob=function(e){if(n.downloadCallback)return n.downloadCallback(e);console.log("TODO")}},scope:{jobCallback:"=",appName:"=",downloadCallback:"="},templateUrl:"./src/clusterpost-app.directive.html"}});