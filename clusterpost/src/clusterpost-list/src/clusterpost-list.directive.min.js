angular.module("clusterpost-list").directive("clusterpostJobs",function(o,e,t,n,c,s){return{restrict:"E",link:function(o,e){o.jobs={selectedJob:{job:{}},edit:{show:!1},showScopes:!1},s.getUser().then(function(e){return o.user=e,s.getScopes().then(function(e){e.data&&e.data[0]?o.clusterScopes=_.filter(e.data[0].scopes,function(o){return"default"!=o&&"admin"!=o&&"clusterpost"!=o}):console.error("No scopes found!")})}).then(function(){return o.getDB()}),o.jobs.onFilter=function(e){o.jobs.filteredJobs=e},o.updateStatus=function(o){t.getJobStatus(o._id).then(function(e){o.jobstatus=e.data}).catch(function(o){throw console.error(o),o})},o.removeJobScope=function(e,t){if(e.scope){var n=e.scope.indexOf(t);if(-1!=n)return e.scope.splice(n,1),o.saveJob(e)}},o.addJobScope=function(e){if(o.jobs.selectedScope)return e.scope||(e.scope=[]),e.scope.push(o.jobs.selectedScope),e.scope=_.uniq(e.scope),o.saveJob(e)},o.addJobsScope=function(e){_.each(o.jobs.filteredJobs,o.addJobScope)},o.removeJobsScope=function(e){_.each(o.jobs.filteredJobs,function(e){o.removeJobScope(e,o.jobs.selectedScope)})},o.killJob=function(o){t.killJob(o._id).then(function(e){o.jobstatus=e.data}).catch(function(o){throw console.error(o),o})},o.removeRow=function(e){var t=o.rowCollection.indexOf(e);-1!==t&&o.rowCollection.splice(t,1)},o.deleteJob=function(e){t.deleteJob(e._id).then(function(t){for(var n=0;n<o.jobs.data.length;n++)o.jobs.data[n]._id===e._id&&o.jobs.data.splice(n,1)}).catch(function(o){throw console.error(o),o})},o.runJob=function(e,n){t.submitJob(e._id,n).then(function(e){o.getDB()}).catch(function(o){console.error(o)})},o.saveJob=function(o){return t.updateJob(angular.copy(o)).then(function(e){e&&e.data&&e.data[0]&&e.data[0].rev&&(o._rev=e.data[0].rev)}).catch(function(o){console.error(o)})},o.getDB=function(){var e={};if(-1!==o.user.scope.indexOf("admin"))e=t.getAllJobs();else{var n={};o.executable&&(n.executable=o.executable),e=t.getUserJobs(n)}e.then(function(e){o.jobs.data=e.data,o.jobs.status=_.uniq(_.pluck(_.pluck(e.data,"jobstatus"),"status")),o.jobs.executables=_.uniq(_.pluck(e.data,"executable"))}).then(function(){return t.getExecutionServers()}).then(function(e){o.executionservers=e.data}).catch(function(o){console.error(o)})},o.showJobDetail=function(e){o.jobs.selectedJob.job=e,o.activeTab=1,t.getAttachment(e._id,"stdout.out","text").then(function(e){o.jobs.selectedJob.stdout=e.data}).catch(console.error),t.getAttachment(e._id,"stderr.err","text").then(function(e){o.jobs.selectedJob.stderr=e.data}).catch(console.error)},o.runAllJobs=function(){if(o.jobs.filteredJobs){var e=_.map(o.jobs.filteredJobs,function(o){return t.submitJob(o._id).then(function(o){console.log(o)}).catch(console.error)});Promise.all(e).catch(console.error)}},o.updateAllJobs=function(){if(o.jobs.filteredJobs){var e=_.map(o.jobs.filteredJobs,function(o){return t.getJobStatus(o._id).then(function(e){o.jobstatus=e.data}).catch(console.error)});Promise.all(e).catch(console.error)}},o.deleteAllJobs=function(){if(o.jobs.filteredJobs){var e=_.map(o.jobs.filteredJobs,o.deleteJob);Promise.all(e).catch(console.error)}},o.killAllJobs=function(){if(o.jobs.filteredJobs){var e=_.map(o.jobs.filteredJobs,o.killJob);Promise.all(e).catch(console.error)}},o.saveJobEdit=function(){o.jobs.edit.showerror=!1;try{var e=JSON.parse(o.jobs.edit.jobtext);t.updateJob(e).then(function(t){o.jobs.edit.show=!1,o.jobs.selectedJob.job=e;for(var n=0;n<o.jobs.data.length;n++)e._id===o.jobs.data[n]._id&&(o.jobs.data[n]=e)}).catch(function(e){o.jobs.edit.error=e.message,o.jobs.edit.showerror=!0})}catch(e){o.jobs.edit.error=e.message,o.jobs.edit.showerror=!0}},o.downloadJob=function(e){return o.downloadCallback?o.downloadCallback(e):t.getJobDownload(e._id).then(function(o){var t=e._id+".tar.gz";e.name&&(t=e.name+".tar.gz"),pom.setAttribute("href",window.URL.createObjectURL(o)),pom.setAttribute("download",t),pom.dataset.downloadurl=["application/octet-stream",pom.download,pom.href].join(":"),pom.click()})},o.downloadAll=function(){if(o.jobs.filteredJobs){var e=_.map(o.jobs.filteredJobs,o.downloadJob);Promise.all(e).catch(console.error)}},o.numJobsInPage=[{id:"0",value:"10"},{id:"1",value:"50"},{id:"2",value:"100"}],o.rowCollection=[],o.forceRunJob=!1,o.activeTab=0,o.$watch("jobs.edit.show",function(){o.jobs.edit.show&&(o.jobs.edit.jobtext=JSON.stringify(o.jobs.selectedJob.job,null,4))})},templateUrl:"./src/clusterpost-jobs.directive.html",scope:{executable:"=",jobCallback:"=",downloadCallback:"="}}}),angular.module("clusterpost-list").directive("onFilter",function(){return{require:"^stTable",scope:{onFilter:"="},link:function(o,e,t,n){o.$watch(n.getFilteredCollection,function(e){o.onFilter&&o.onFilter(e)})}}});