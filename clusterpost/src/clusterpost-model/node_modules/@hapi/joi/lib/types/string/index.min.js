"use strict";const Net=require("net"),Address=require("@hapi/address"),Hoek=require("@hapi/hoek"),Any=require("../any"),Ref=require("../../ref"),JoiDate=require("../date"),Uri=require("./uri"),Ip=require("./ip"),internals={uriRegex:Uri.createUriRegex(),ipRegex:Ip.createIpRegex(["ipv4","ipv6","ipvfuture"],"optional"),guidBrackets:{"{":"}","[":"]","(":")","":""},guidVersions:{uuidv1:"1",uuidv2:"2",uuidv3:"3",uuidv4:"4",uuidv5:"5"},cidrPresences:["required","optional","forbidden"],normalizationForms:["NFC","NFD","NFKC","NFKD"]};internals.String=class extends Any{constructor(){super(),this._type="string",this._invalids.add("")}_base(e,t,r){if("string"==typeof e&&r.convert){if(this._flags.normalize&&(e=e.normalize(this._flags.normalize)),this._flags.case&&(e="upper"===this._flags.case?e.toLocaleUpperCase():e.toLocaleLowerCase()),this._flags.trim&&(e=e.trim()),this._inner.replacements)for(let t=0;t<this._inner.replacements.length;++t){const r=this._inner.replacements[t];e=e.replace(r.pattern,r.replacement)}if(this._flags.truncate)for(let t=0;t<this._tests.length;++t){const r=this._tests[t];if("max"===r.name){e=e.slice(0,r.arg);break}}this._flags.byteAligned&&e.length%2!=0&&(e=`0${e}`)}return{value:e,errors:"string"==typeof e?null:this.createError("string.base",{value:e},t,r)}}insensitive(){if(this._flags.insensitive)return this;const e=this.clone();return e._flags.insensitive=!0,e}creditCard(){return this._test("creditCard",void 0,function(e,t,r){let s=e.length,i=0,n=1;for(;s--;){const t=e.charAt(s)*n;i+=t-9*(t>9),n^=3}return i%10==0&&i>0?e:this.createError("string.creditCard",{value:e},t,r)})}regex(e,t){Hoek.assert(e instanceof RegExp,"pattern must be a RegExp"),Hoek.assert(!e.flags.includes("g")&&!e.flags.includes("y"),"pattern should not use global or sticky mode");const r={pattern:e};"string"==typeof t?r.name=t:"object"==typeof t&&(r.invert=!!t.invert,t.name&&(r.name=t.name));const s=["string.regex",r.invert?".invert":"",r.name?".name":".base"].join("");return this._test("regex",r,function(e,t,i){return r.pattern.test(e)^r.invert?e:this.createError(s,{name:r.name,pattern:r.pattern,value:e},t,i)})}alphanum(){return this._test("alphanum",void 0,function(e,t,r){return/^[a-zA-Z0-9]+$/.test(e)?e:this.createError("string.alphanum",{value:e},t,r)})}token(){return this._test("token",void 0,function(e,t,r){return/^\w+$/.test(e)?e:this.createError("string.token",{value:e},t,r)})}email(e){if(e){if(Hoek.assert("object"==typeof e,"email options must be an object"),Hoek.assert(void 0===e.checkDNS,"checkDNS option is not supported"),Hoek.assert(void 0===e.errorLevel,"errorLevel option is not supported"),Hoek.assert(void 0===e.minDomainAtoms,"minDomainAtoms option is not supported, use minDomainSegments instead"),Hoek.assert(void 0===e.tldBlacklist,"tldBlacklist option is not supported, use tlds.deny instead"),Hoek.assert(void 0===e.tldWhitelist,"tldWhitelist option is not supported, use tlds.allow instead"),e.tlds&&"object"==typeof e.tlds){Hoek.assert(void 0===e.tlds.allow||!1===e.tlds.allow||!0===e.tlds.allow||Array.isArray(e.tlds.allow)||e.tlds.allow instanceof Set,"tlds.allow must be an array, Set, or boolean"),Hoek.assert(void 0===e.tlds.deny||Array.isArray(e.tlds.deny)||e.tlds.deny instanceof Set,"tlds.deny must be an array or Set");const t=e=>void 0===e||"boolean"==typeof e||e instanceof Set?e:new Set(e);(e=Object.assign({},e)).tlds={allow:t(e.tlds.allow),deny:t(e.tlds.deny)}}Hoek.assert(void 0===e.minDomainSegments||Number.isSafeInteger(e.minDomainSegments)&&e.minDomainSegments>0,"minDomainSegments must be a positive integer")}return this._test("email",e,function(t,r,s){return Address.email.isValid(t,e)?t:this.createError("string.email",{value:t},r,s)})}ip(e={}){let t,r=internals.ipRegex;if(Hoek.assert("object"==typeof e,"options must be an object"),e.cidr?(Hoek.assert("string"==typeof e.cidr,"cidr must be a string"),e.cidr=e.cidr.toLowerCase(),Hoek.assert(Hoek.contain(internals.cidrPresences,e.cidr),"cidr must be one of "+internals.cidrPresences.join(", ")),e.version||"optional"===e.cidr||(r=Ip.createIpRegex(["ipv4","ipv6","ipvfuture"],e.cidr))):e.cidr="optional",e.version){Array.isArray(e.version)||(e.version=[e.version]),Hoek.assert(e.version.length>=1,"version must have at least 1 version specified"),t=[];for(let r=0;r<e.version.length;++r){let s=e.version[r];Hoek.assert("string"==typeof s,"version at position "+r+" must be a string"),s=s.toLowerCase(),Hoek.assert(Ip.versions[s],"version at position "+r+" must be one of "+Object.keys(Ip.versions).join(", ")),t.push(s)}t=Array.from(new Set(t)),r=Ip.createIpRegex(t,e.cidr)}return this._test("ip",e,function(s,i,n){return r.test(s)?s:t?this.createError("string.ipVersion",{value:s,cidr:e.cidr,version:t},i,n):this.createError("string.ip",{value:s,cidr:e.cidr},i,n)})}uri(e){let t="",r=!1,s=!1,i=!1,n=internals.uriRegex;if(e){Hoek.assert("object"==typeof e,"options must be an object");const n=Object.keys(e).filter(e=>!["scheme","allowRelative","relativeOnly","allowQuerySquareBrackets"].includes(e));if(Hoek.assert(0===n.length,`options contain unknown keys: ${n}`),e.scheme){Hoek.assert(e.scheme instanceof RegExp||"string"==typeof e.scheme||Array.isArray(e.scheme),"scheme must be a RegExp, String, or Array"),Array.isArray(e.scheme)||(e.scheme=[e.scheme]),Hoek.assert(e.scheme.length>=1,"scheme must have at least 1 scheme specified");for(let r=0;r<e.scheme.length;++r){const s=e.scheme[r];Hoek.assert(s instanceof RegExp||"string"==typeof s,"scheme at position "+r+" must be a RegExp or String"),t+=t?"|":"",s instanceof RegExp?t+=s.source:(Hoek.assert(/[a-zA-Z][a-zA-Z0-9+-\.]*/.test(s),"scheme at position "+r+" must be a valid scheme"),t+=Hoek.escapeRegex(s))}}e.allowRelative&&(r=!0),e.relativeOnly&&(s=!0),e.allowQuerySquareBrackets&&(i=!0)}return(t||r||s||i)&&(n=Uri.createUriRegex(t,r,s,i)),this._test("uri",e,function(e,r,i){return n.test(e)?e:s?this.createError("string.uriRelativeOnly",{value:e},r,i):t?this.createError("string.uriCustomScheme",{scheme:t,value:e},r,i):this.createError("string.uri",{value:e},r,i)})}isoDate(){return this._test("isoDate",void 0,function(e,t,r){if(JoiDate._isIsoDate(e)){if(!r.convert)return e;const t=new Date(e);if(!isNaN(t.getTime()))return t.toISOString()}return this.createError("string.isoDate",{value:e},t,r)})}guid(e){let t="";if(e&&e.version){Array.isArray(e.version)||(e.version=[e.version]),Hoek.assert(e.version.length>=1,"version must have at least 1 valid version specified");const r=new Set;for(let s=0;s<e.version.length;++s){let i=e.version[s];Hoek.assert("string"==typeof i,"version at position "+s+" must be a string"),i=i.toLowerCase();const n=internals.guidVersions[i];Hoek.assert(n,"version at position "+s+" must be one of "+Object.keys(internals.guidVersions).join(", ")),Hoek.assert(!r.has(n),"version at position "+s+" must not be a duplicate."),t+=n,r.add(n)}}const r=new RegExp(`^([\\[{\\(]?)[0-9A-F]{8}([:-]?)[0-9A-F]{4}\\2?[${t||"0-9A-F"}][0-9A-F]{3}\\2?[${t?"89AB":"0-9A-F"}][0-9A-F]{3}\\2?[0-9A-F]{12}([\\]}\\)]?)$`,"i");return this._test("guid",e,function(e,t,s){const i=r.exec(e);return i?internals.guidBrackets[i[1]]!==i[i.length-1]?this.createError("string.guid",{value:e},t,s):e:this.createError("string.guid",{value:e},t,s)})}hex(e={}){Hoek.assert("object"==typeof e,"hex options must be an object"),Hoek.assert(void 0===e.byteAligned||"boolean"==typeof e.byteAligned,"byteAligned must be boolean");const t=!0===e.byteAligned,r=/^[a-f0-9]+$/i,s=this._test("hex",r,function(e,s,i){return r.test(e)?t&&e.length%2!=0?this.createError("string.hexAlign",{value:e},s,i):e:this.createError("string.hex",{value:e},s,i)});return t&&(s._flags.byteAligned=!0),s}base64(e={}){Hoek.assert("object"==typeof e,"base64 options must be an object"),Hoek.assert(void 0===e.paddingRequired||"boolean"==typeof e.paddingRequired,"paddingRequired must be boolean");const t=(!1===e.paddingRequired?e.paddingRequired:e.paddingRequired||!0)?/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/:/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}(==)?|[A-Za-z0-9+\/]{3}=?)?$/;return this._test("base64",t,function(e,r,s){return t.test(e)?e:this.createError("string.base64",{value:e},r,s)})}dataUri(e={}){const t=/^data:[\w+.-]+\/[\w+.-]+;((charset=[\w-]+|base64),)?(.*)$/,r=(!1===e.paddingRequired?e.paddingRequired:e.paddingRequired||!0)?/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/:/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}(==)?|[A-Za-z0-9+\/]{3}=?)?$/;return this._test("dataUri",t,function(e,s,i){const n=e.match(t);if(n){if(!n[2])return e;if("base64"!==n[2])return e;if(r.test(n[3]))return e}return this.createError("string.dataUri",{value:e},s,i)})}hostname(){const e=/^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$/;return this._test("hostname",void 0,function(t,r,s){return t.length<=255&&e.test(t)||Net.isIPv6(t)?t:this.createError("string.hostname",{value:t},r,s)})}normalize(e="NFC"){Hoek.assert(Hoek.contain(internals.normalizationForms,e),"normalization form must be one of "+internals.normalizationForms.join(", "));const t=this._test("normalize",e,function(t,r,s){return s.convert||t===t.normalize(e)?t:this.createError("string.normalize",{value:t,form:e},r,s)});return t._flags.normalize=e,t}lowercase(){const e=this._test("lowercase",void 0,function(e,t,r){return r.convert||e===e.toLocaleLowerCase()?e:this.createError("string.lowercase",{value:e},t,r)});return e._flags.case="lower",e}uppercase(){const e=this._test("uppercase",void 0,function(e,t,r){return r.convert||e===e.toLocaleUpperCase()?e:this.createError("string.uppercase",{value:e},t,r)});return e._flags.case="upper",e}trim(e=!0){if(Hoek.assert("boolean"==typeof e,"option must be a boolean"),this._flags.trim&&e||!this._flags.trim&&!e)return this;let t;return e?t=this._test("trim",void 0,function(e,t,r){return r.convert||e===e.trim()?e:this.createError("string.trim",{value:e},t,r)}):(t=this.clone())._tests=t._tests.filter(e=>"trim"!==e.name),t._flags.trim=e,t}replace(e,t){"string"==typeof e&&(e=new RegExp(Hoek.escapeRegex(e),"g")),Hoek.assert(e instanceof RegExp,"pattern must be a RegExp"),Hoek.assert("string"==typeof t,"replacement must be a String");const r=this.clone();return r._inner.replacements||(r._inner.replacements=[]),r._inner.replacements.push({pattern:e,replacement:t}),r}truncate(e){const t=void 0===e||!!e;if(this._flags.truncate===t)return this;const r=this.clone();return r._flags.truncate=t,r}},internals.compare=function(e,t){return function(r,s){const i=Ref.isRef(r);return Hoek.assert(Number.isSafeInteger(r)&&r>=0||i,"limit must be a positive integer or reference"),Hoek.assert(!s||Buffer.isEncoding(s),"Invalid encoding:",s),this._test(e,r,function(n,a,o){let l;if(i){if(l=r(a.reference||a.parent,o),!Number.isSafeInteger(l))return this.createError("string.ref",{ref:r,value:l},a,o)}else l=r;return t(n,l,s)?n:this.createError("string."+e,{limit:l,value:n,encoding:s},a,o)})}},internals.String.prototype.min=internals.compare("min",(e,t,r)=>{return(r?Buffer.byteLength(e,r):e.length)>=t}),internals.String.prototype.max=internals.compare("max",(e,t,r)=>{return(r?Buffer.byteLength(e,r):e.length)<=t}),internals.String.prototype.length=internals.compare("length",(e,t,r)=>{return(r?Buffer.byteLength(e,r):e.length)===t}),internals.String.prototype.uuid=internals.String.prototype.guid,module.exports=new internals.String;